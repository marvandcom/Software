<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediLedger — Doctor Finance (Demo)</title>
  <!-- Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg: #0b1220;
      --panel: #0f172a;   /* slate-900 */
      --panel-2: #111827; /* gray-900 */
      --muted: #94a3b8;   /* slate-400 */
      --text: #e5e7eb;    /* gray-200 */
      --brand: #22d3ee;   /* cyan-400 */
      --brand-2: #34d399; /* emerald-400 */
      --danger: #fb7185;  /* rose-400 */
      --warning: #f59e0b; /* amber-500 */
      --ring: rgba(34,211,238,.35);
      --card: #0b1220;
      --border: rgba(148,163,184,.15);
      --ok: #10b981;
      --bad: #ef4444;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:linear-gradient(180deg, var(--bg), #101826 40%, #0b1220);
      color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    /* Layout */
    .app{ display:grid; grid-template-columns:260px 1fr; min-height:100vh }
    aside{
      border-right:1px solid var(--border);
      background:linear-gradient(180deg, #0d1424, #0b1220);
      padding:22px 16px; position:sticky; top:0; height:100vh; overflow:auto;
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.3px; font-size:20px; }
    .brand .logo{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:radial-gradient(60% 80% at 30% 20%, rgba(52,211,153,.35), transparent 60%), radial-gradient(70% 80% at 70% 80%, rgba(34,211,238,.4), transparent 60%); border:1px solid var(--border) }
    .brand small{ color:var(--muted); font-weight:600 }

    nav{ margin-top:18px; display:grid; gap:6px }
    .nav-btn{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; text-decoration:none; color:var(--text); border:1px solid transparent; transition:.2s all;
      background:transparent; cursor:pointer; font-weight:600 }
    .nav-btn:hover{ background:rgba(148,163,184,.06); border-color:var(--border) }
    .nav-btn.active{ background:linear-gradient(180deg, rgba(34,211,238,.12), rgba(52,211,153,.12)); border-color:var(--ring) }
    .nav-btn svg{ width:18px; height:18px; opacity:.9 }

    .aside-footer{ margin-top:auto; font-size:12px; color:var(--muted) }

    main{ padding:28px; }
    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:18px }
    .toolbar .search{ flex:1; min-width:220px; }
    .search input{
      width:100%; padding:10px 12px; background:#0b1424; border-radius:12px; border:1px solid var(--border); color:var(--text);
      outline:0; transition:box-shadow .2s ease, border .2s ease;
    }
    .search input:focus{ box-shadow:0 0 0 4px var(--ring); border-color:var(--brand) }

    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#0c1526; color:var(--text); font-weight:700; cursor:pointer }
    .btn:hover{ filter:brightness(1.1) }
    .btn.primary{ background:linear-gradient(180deg, rgba(34,211,238,.2), rgba(52,211,153,.2)); border-color:var(--ring) }
    .btn.ghost{ background:transparent }

    .cards{ display:grid; grid-template-columns:repeat(12, 1fr); gap:14px; }
    .card{ grid-column:span 12; background:linear-gradient(180deg, #0d1525, #0b1220); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
    .card-title{ font-weight:700; letter-spacing:.3px; display:flex; align-items:center; gap:8px; margin-bottom:10px }
    .kpi{ display:flex; align-items:baseline; gap:10px; font-weight:800; font-size:28px }
    .kpi small{ color:var(--muted); font-weight:700; font-size:12px }

    @media (min-width: 640px){ .card{ grid-column:span 6 } }
    @media (min-width: 980px){ .card{ grid-column:span 4 } }

    .grid-2{ display:grid; grid-template-columns:1fr; gap:14px }
    @media (min-width: 980px){ .grid-2{ grid-template-columns:1fr 1fr } }

    .chart-wrap{ padding:6px 0 0 }

    /* Table */
    table{ width:100%; border-collapse:collapse; font-size:14px }
    thead th{ text-align:left; font-weight:700; color:var(--muted); border-bottom:1px solid var(--border); padding:10px }
    tbody td{ padding:10px; border-bottom:1px dashed var(--border) }
    tbody tr:hover{ background:rgba(148,163,184,.06) }
    .pill{ display:inline-flex; gap:6px; align-items:center; padding:4px 8px; border-radius:999px; border:1px solid var(--border); font-weight:700; font-size:12px }
    .pill.income{ color:#10b981; border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.12) }
    .pill.expense{ color:#f43f5e; border-color:rgba(244,63,94,.35); background:rgba(244,63,94,.12) }

    /* Form */
    .form{ display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width: 860px){ .form{ grid-template-columns:repeat(2, 1fr) } }
    .form .field{ display:grid; gap:8px }
    .form label{ font-weight:700; font-size:13px; color:var(--muted) }
    .form input, .form select, .form textarea{
      width:100%; padding:11px 12px; border-radius:12px; background:#0b1424; border:1px solid var(--border); color:var(--text); outline:0
    }
    .form textarea{ min-height:88px; grid-column:1 / -1 }

    .footer-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px }

    /* Badges */
    .ok{ color:var(--ok) } .bad{ color:var(--bad) }

    /* Sections routing */
    section[hidden]{ display:none !important }

    /* Tiny helpers */
    .muted{ color:var(--muted) }
    .space{ height:8px }
    .spacer{ height:18px }
    .divider{ height:1px; background:var(--border); margin:10px 0 }
    .right{ text-align:right }
    .center{ text-align:center }

    .hero{ display:grid; gap:16px; padding:12px 0 18px }
    .hero h1{ font-size:32px; line-height:1.1; margin:0 }
    .hero p{ color:var(--muted); max-width:60ch }
    .hero .cta{ display:flex; gap:10px; flex-wrap:wrap }

    .notice{ font-size:12px; color:var(--muted) }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- simple cross icon -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/></svg>
        </div>
        MediLedger<br/>
      </div>
      <small class="muted">Doctor Finance — Demo</small>

      <nav aria-label="Primary">
        <button class="nav-btn active" data-route="landing">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
          Landing
        </button>
        <button class="nav-btn" data-route="add">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
          Add Transaction
        </button>
        <button class="nav-btn" data-route="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h7v9H3zM14 3h7v5h-7zM14 12h7v9h-7zM3 15h7v6H3z"/></svg>
          Dashboard
        </button>
        <button class="nav-btn" data-route="list">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
          Transactions
        </button>
      </nav>

      <div class="spacer"></div>
      <button class="btn primary" id="seedBtn">Load Sample Data</button>
      <div class="space"></div>
      <button class="btn ghost" id="clearBtn">Clear All Data</button>

      <div class="aside-footer">
        <div class="divider"></div>
        <div>Currency: <strong id="currencyLabel">₹</strong></div>
        <div class="space"></div>
        <label class="muted" for="currencySelect">Change</label>
        <select id="currencySelect" style="width:100%; padding:8px 10px; border-radius:10px; background:#0b1424; border:1px solid var(--border); color:var(--text)">
          <option value="INR">INR (₹)</option>
          <option value="USD">USD ($)</option>
          <option value="EUR">EUR (€)</option>
          <option value="GBP">GBP (£)</option>
        </select>
        <div class="space"></div>
        <small class="notice">Your entries are stored locally in your browser (LocalStorage) in this demo.</small>
      </div>
    </aside>

    <main>
      <div class="toolbar">
        <div class="search"><input id="search" type="search" placeholder="Search patient, ID, notes... (⌘/Ctrl + K)"/></div>
        <button class="btn" data-route="add">+ New Transaction</button>
        <button class="btn" id="exportCsv">Export CSV</button>
      </div>

      <!-- Landing -->
      <section id="landing">
        <div class="hero">
          <h1>Manage your clinic finances with clarity.</h1>
          <p>MediLedger helps doctors track income and expenses, visualize trends, and keep a clean audit trail — without spreadsheets. This single-file demo runs entirely in your browser.</p>
          <div class="cta">
            <button class="btn primary" data-route="add">Add your first transaction</button>
            <button class="btn" data-route="dashboard">View dashboard</button>
          </div>
        </div>

        <div class="cards">
          <div class="card">
            <div class="card-title">Why MediLedger?</div>
            <ul class="muted">
              <li>Fast add form with patient context</li>
              <li>Clean charts for monthly income vs expenses</li>
              <li>Category insights and CSV export</li>
            </ul>
          </div>
          <div class="card">
            <div class="card-title">Privacy-first (Demo)</div>
            <p class="muted">Data is saved only in your browser. Connect a backend later (Google Sheets, Firebase, Supabase) to collaborate.</p>
          </div>
          <div class="card">
            <div class="card-title">Next steps</div>
            <p class="muted">Turn this into a full app by wiring the form to your backend API and replacing LocalStorage reads/writes with fetch calls.</p>
          </div>
        </div>
      </section>

      <!-- Add Transaction -->
      <section id="add" hidden>
        <h2 class="card-title">Add Transaction</h2>
        <form id="txForm" class="form" autocomplete="on">
          <div class="field">
            <label for="date">Date</label>
            <input id="date" name="date" type="date" required />
          </div>
          <div class="field">
            <label for="type">Type</label>
            <select id="type" name="type" required>
              <option value="Income">Income</option>
              <option value="Expense">Expense</option>
            </select>
          </div>
          <div class="field">
            <label for="amount">Amount</label>
            <input id="amount" name="amount" type="number" step="0.01" min="0" placeholder="0.00" required />
          </div>
          <div class="field">
            <label for="category">Category</label>
            <select id="category" name="category" required>
              <option>Consultation</option>
              <option>Procedure</option>
              <option>Diagnostics</option>
              <option>Pharmacy</option>
              <option>Supplies</option>
              <option>Rent</option>
              <option>Utilities</option>
              <option>Staff</option>
              <option>Misc</option>
            </select>
          </div>
          <div class="field">
            <label for="patientName">Patient Name (optional for expenses)</label>
            <input id="patientName" name="patientName" type="text" placeholder="e.g., Rahul Kumar" />
          </div>
          <div class="field">
            <label for="patientId">Patient ID</label>
            <input id="patientId" name="patientId" type="text" placeholder="e.g., P-1024" />
          </div>
          <div class="field">
            <label for="phone">Phone</label>
            <input id="phone" name="phone" type="tel" placeholder="e.g., 98765 43210" />
          </div>
          <div class="field">
            <label for="payment">Payment Method</label>
            <select id="payment" name="payment">
              <option>Cash</option>
              <option>Card</option>
              <option>UPI</option>
              <option>Insurance</option>
              <option>Bank Transfer</option>
            </select>
          </div>
          <div class="field" style="grid-column:1 / -1">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" placeholder="Add any details..."></textarea>
          </div>
          <div class="footer-actions" style="grid-column:1 / -1">
            <button type="reset" class="btn">Reset</button>
            <button type="submit" class="btn primary">Save Transaction</button>
          </div>
        </form>
      </section>

      <!-- Dashboard -->
      <section id="dashboard" hidden>
        <h2 class="card-title">Dashboard</h2>
        <div class="cards">
          <div class="card">
            <div class="kpi"><span id="kpiIncome">₹0</span> <small>Total Income</small></div>
          </div>
          <div class="card">
            <div class="kpi"><span id="kpiExpense">₹0</span> <small>Total Expenses</small></div>
          </div>
          <div class="card">
            <div class="kpi"><span id="kpiNet">₹0</span> <small>Net</small></div>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="grid-2">
          <div class="card">
            <div class="card-title">Monthly Income vs Expense</div>
            <div class="chart-wrap"><canvas id="monthlyChart" height="120"></canvas></div>
          </div>
          <div class="card">
            <div class="card-title">By Category</div>
            <div class="chart-wrap"><canvas id="categoryChart" height="120"></canvas></div>
          </div>
        </div>
      </section>

      <!-- Transactions List -->
      <section id="list" hidden>
        <h2 class="card-title">Transactions</h2>
        <div class="card">
          <table id="txTable" aria-label="Transactions table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Patient</th>
                <th>Payment</th>
                <th>Notes</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

  <script>
    // ====== Utilities ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    const API_BASE = "/api/transactions";
    const currencyKey = 'mediledger.currency';

    const currencyMap = {
      INR: { symbol:'₹', locale: 'en-IN' },
      USD: { symbol:'$', locale: 'en-US' },
      EUR: { symbol:'€', locale: 'de-DE' },
      GBP: { symbol:'£', locale: 'en-GB' },
    };

    let transactions = [];
    let currentCurrency = localStorage.getItem(currencyKey) || 'INR';

    function fmtMoney(n){
      const cfg = currencyMap[currentCurrency] || currencyMap.INR;
      try{ return new Intl.NumberFormat(cfg.locale, { style:'currency', currency: currentCurrency }).format(n); }
      catch{ return cfg.symbol + (n||0).toFixed(2) }
    }

    // ====== Routing ======
    function go(route){
      $$('.nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.route===route));
      $$('main > section').forEach(s=>{
        s.hidden = (s.id !== route);
      });
    }

    // ====== API Communication ======
    async function load(){
      try {
        const response = await fetch(API_BASE);
        if (!response.ok) throw new Error('Failed to fetch transactions');
        const data = await response.json();

        // Transform backend data to match frontend format
        transactions = data.map(item => ({
          id: item.ID,
          date: item.Date,
          type: item.Type,
          amount: parseFloat(item.Amount),
          category: item.Category,
          patientName: item['Patient Name'],
          patientId: item['Patient ID'],
          phone: item.Phone,
          payment: item.Payment,
          notes: item.Notes
        }));
      } catch (error) {
        console.error("Error loading transactions:", error);
        alert("Failed to load transactions. Check console for details.");
        transactions = [];
      }
    }

    async function saveTransaction(tx) {
      try {
        const response = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            date: tx.date,
            type: tx.type,
            amount: tx.amount,
            category: tx.category,
            patientName: tx.patientName,
            patientId: tx.patientId,
            phone: tx.phone,
            payment: tx.payment,
            notes: tx.notes
          })
        });

        if (!response.ok) throw new Error('Failed to save transaction');
        await load(); // Reload data from backend
        return true;
      } catch (error) {
        console.error("Error saving transaction:", error);
        alert("Failed to save transaction. Check console for details.");
        return false;
      }
    }

    async function deleteTransaction(id) {
      try {
        const response = await fetch(`${API_BASE}/${id}`, {
          method: "DELETE"
        });

        if (!response.ok) throw new Error('Failed to delete transaction');
        await load(); // Reload data from backend
        return true;
      } catch (error) {
        console.error("Error deleting transaction:", error);
        alert("Failed to delete transaction. Check console for details.");
        return false;
      }
    }

    // ====== Form Submit ======
    $('#txForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const amount = parseFloat(data.amount || '0');
      if(!isFinite(amount) || amount <= 0){ alert('Enter a valid amount'); return; }

      const tx = {
        date: data.date || new Date().toISOString().slice(0,10),
        type: data.type,
        amount,
        category: data.category,
        patientName: data.patientName?.trim() || '',
        patientId: data.patientId?.trim() || '',
        phone: data.phone?.trim() || '',
        payment: data.payment,
        notes: data.notes?.trim() || ''
      };

      const success = await saveTransaction(tx);
      if (success) {
        e.target.reset();
        $('#date').value = new Date().toISOString().slice(0,10);
        renderAll();
        go('list');
      }
    });

    // ====== Rendering ======
    function renderKPIs(){
      const income = transactions.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
      const expense = transactions.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
      $('#kpiIncome').textContent = fmtMoney(income);
      $('#kpiExpense').textContent = fmtMoney(expense);
      $('#kpiNet').textContent = fmtMoney(income - expense);
    }

    function monthlyBuckets(){
      const map = new Map(); // key: YYYY-MM
      for(const t of transactions){
        const ym = (t.date||'').slice(0,7);
        if(!map.has(ym)) map.set(ym, { income:0, expense:0 });
        map.get(ym)[t.type.toLowerCase()] += t.amount;
      }
      const keys = [...map.keys()].sort();
      const income = keys.map(k=>map.get(k).income);
      const expense = keys.map(k=>map.get(k).expense);
      return { labels: keys, income, expense };
    }

    function categoryTotals(){
      const map = new Map();
      for(const t of transactions){
        const k = t.category||'Misc';
        if(!map.has(k)) map.set(k, { income:0, expense:0 });
        map.get(k)[t.type.toLowerCase()] += t.amount;
      }
      const labels = [...map.keys()].sort();
      const totals = labels.map(l=> map.get(l).income - map.get(l).expense );
      return { labels, totals };
    }

    let monthlyChart, categoryChart;
    function renderCharts(){
      const m = monthlyBuckets();
      const c = categoryTotals();

      const ctxM = $('#monthlyChart');
      const ctxC = $('#categoryChart');

      if(monthlyChart) monthlyChart.destroy();
      if(categoryChart) categoryChart.destroy();

      monthlyChart = new Chart(ctxM, {
        type:'bar',
        data:{ labels: m.labels, datasets:[
          { label:'Income', data:m.income, borderWidth:2 },
          { label:'Expense', data:m.expense, borderWidth:2 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });

      categoryChart = new Chart(ctxC, {
        type:'bar',
        data:{ labels:c.labels, datasets:[ { label:'Net by Category', data:c.totals, borderWidth:2 } ] },
        options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{ x:{ beginAtZero:true } } }
      });
    }

    function renderTable(){
      const tbody = $('#txTable tbody');
      const q = $('#search').value.trim().toLowerCase();
      tbody.innerHTML = '';
      const cfg = currencyMap[currentCurrency];

      const rows = transactions.filter(t=>{
        if(!q) return true;
        return [t.patientName, t.patientId, t.phone, t.category, t.payment, t.notes].some(v=> String(v||'').toLowerCase().includes(q));
      }).map(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.date}</td>
          <td><span class="pill ${t.type.toLowerCase()}">${t.type}</span></td>
          <td>${fmtMoney(t.amount)}</td>
          <td>${t.category}</td>
          <td>${t.patientName || '-'}${t.patientId?` <span class="muted">(${t.patientId})</span>`:''}</td>
          <td>${t.payment}</td>
          <td>${t.notes || ''}</td>
          <td class="right"><button class="btn ghost" data-del="${t.id}">Delete</button></td>
        `;
        return tr;
      });

      rows.forEach(r=>tbody.appendChild(r));

      // delete handlers
      $$('button[data-del]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-del');
          if(confirm('Are you sure you want to delete this transaction?')) {
            await deleteTransaction(id);
          }
        }
      })
    }

    function renderAll(){
      renderKPIs();
      renderCharts();
      renderTable();
      $('#currencyLabel').textContent = currencyMap[currentCurrency].symbol;
    }

    // ====== CSV Export ======
    function toCSV(){
      const header = ['Date','Type','Amount','Category','Patient Name','Patient ID','Phone','Payment','Notes'];
      const lines = transactions.map(t=>[
        t.date, t.type, t.amount, t.category, t.patientName, t.patientId, t.phone, t.payment, (t.notes||'').replaceAll('\n',' ')
      ]);
      const csv = [header, ...lines].map(r=> r.map(v=>`"${String(v??'').replaceAll('"','\"')}"`).join(',')).join('\n');
      return csv;
    }

    $('#exportCsv').onclick = ()=>{
      const blob = new Blob([toCSV()], { type:'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `mediLedger-transactions-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Remove seed and clear functionality as they don't apply to backend
    $('#seedBtn').style.display = 'none';
    $('#clearBtn').style.display = 'none';

    // Currency change
    const currencySelect = $('#currencySelect');
    currencySelect.value = currentCurrency;
    currencySelect.onchange = ()=>{
      currentCurrency = currencySelect.value;
      localStorage.setItem(currencyKey, currentCurrency);
      renderAll();
    }

    // Search
    $('#search').addEventListener('input', renderTable);
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#search').focus(); }
    });

    // Nav buttons
    $$('button[data-route]').forEach(btn=> btn.addEventListener('click', ()=> go(btn.dataset.route)));

    // Init
    load();
    $('#date').value = new Date().toISOString().slice(0,10);
    renderAll();
  </script>
</body>
</html>
