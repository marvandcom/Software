<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediLedger — Doctor Finance (Demo)</title>
  <!-- Icons & Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    :root{
      --bg: #0b1220;
      --panel: #0f172a;
      --panel-2: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --brand: #22d3ee;
      --brand-2: #34d399;
      --danger: #fb7185;
      --warning: #f59e0b;
      --ring: rgba(34,211,238,.35);
      --card: #0b1220;
      --border: rgba(148,163,184,.15);
      --ok: #10b981;
      --bad: #ef4444;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:linear-gradient(180deg, var(--bg), #101826 40%, #0b1220);
      color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .app{ display:grid; grid-template-columns:260px 1fr; min-height:100vh }
    aside{
      border-right:1px solid var(--border);
      background:linear-gradient(180deg, #0d1424, #0b1220);
      padding:22px 16px; position:sticky; top:0; height:100vh; overflow:auto;
      box-shadow: 0 1px 12px rgba(34,211,238,.07);
    }
    .brand{ display:flex; gap:10px; align-items:center; font-weight:800; letter-spacing:.3px; font-size:20px; }
    .brand .logo{ width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:radial-gradient(60% 80% at 30% 20%, rgba(52,211,153,.35), transparent 60%), radial-gradient(70% 80% at 70% 80%, rgba(34,211,238,.4), transparent 60%); border:1px solid var(--border) }
    .brand small{ color:var(--muted); font-weight:600 }
    nav{ margin-top:18px; display:grid; gap:6px }
    .nav-btn{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; text-decoration:none; color:var(--text); border:1px solid transparent; transition:.2s all; background:transparent; cursor:pointer; font-weight:600 }
    .nav-btn:hover{ background:rgba(148,163,184,.06); border-color:var(--border) }
    .nav-btn.active{ background:linear-gradient(180deg, rgba(34,211,238,.12), rgba(52,211,153,.12)); border-color:var(--ring) }
    .nav-btn svg{ width:18px; height:18px; opacity:.9 }
    .aside-footer{ margin-top:auto; font-size:12px; color:var(--muted) }
    main{ padding:28px; }
    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:18px }
    .toolbar .search{ flex:1; min-width:220px; }
    .search input{
      width:100%; padding:10px 12px; background:#0b1424; border-radius:12px; border:1px solid var(--border); color:var(--text);
      outline:0; transition:box-shadow .2s ease, border .2s ease;
    }
    .search input:focus{ box-shadow:0 0 0 4px var(--ring); border-color:var(--brand) }
    .btn, .tab-btn {
      padding: 11px 18px;
      border-radius: 14px;
      font-weight: 700;
      letter-spacing: 0.03em;
      background: linear-gradient(90deg, rgba(34,211,238,.17), rgba(52,211,153,.16));
      border: 1px solid var(--border);
      color: var(--text);
      box-shadow: 0 1px 6px rgba(34,211,238,.09);
      transition: filter .2s, box-shadow .2s, background .2s;
    }
    .btn:hover, .tab-btn:hover, .btn.active, .tab-btn.active {
      filter: brightness(1.19);
      box-shadow: 0 4px 16px rgba(34,211,238,0.16);
      background: linear-gradient(90deg, rgba(34,211,238,.23), rgba(52,211,153,.24));
    }
    .btn.primary, .tab-btn.active {
      background: linear-gradient(90deg, rgba(34,211,238,.32), rgba(52,211,153,.31));
      border-color: var(--ring);
      color: #fff;
    }
    .btn.ghost{ background:transparent }
    .cards{ display:grid; grid-template-columns:repeat(12, 1fr); gap:14px; }
    .card, .form, .presc-table, .inv-table {
      box-shadow: 0 2px 16px rgba(34,211,238,0.09), 0 1.5px 6px rgba(52,211,153,0.07);
      border-radius: 18px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #101826 80%, #0b1220 100%);
      transition: box-shadow .21s, transform .21s;
      margin-bottom: 16px;
    }
    .card:hover, .form:hover {
      box-shadow: 0 8px 32px rgba(34,211,238,0.14), 0 3px 18px rgba(52,211,153,0.10);
      transform: translateY(-2px) scale(1.012);
    }
    .card-title, h2.card-title {
      font-size: 1.35rem;
      font-weight: 800;
      color: var(--brand);
      margin-bottom: 10px;
      letter-spacing: .04em;
      text-shadow: 0 1px 6px rgba(34,211,238,.12);
      display:flex; align-items:center; gap:8px;
    }
    .kpi{ display:flex; align-items:baseline; gap:10px; font-weight:800; font-size:28px }
    .kpi small{ color:var(--muted); font-weight:700; font-size:12px }
    @media (min-width: 640px){ .card{ grid-column:span 6 } }
    @media (min-width: 980px){ .card{ grid-column:span 4 } }
    .grid-2{ display:grid; grid-template-columns:1fr; gap:14px }
    @media (min-width: 980px){ .grid-2{ grid-template-columns:1fr 1fr } }
    .chart-wrap{ padding:6px 0 0 }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    table th, table td {
      padding: 12px 10px;
    }
    table thead {
      background: linear-gradient(90deg, rgba(34,211,238,.06), rgba(52,211,153,.10));
    }
    table tbody tr:hover {
      background: linear-gradient(90deg, rgba(34,211,238,.08), rgba(52,211,153,.09));
      cursor: pointer;
      transition: background .18s;
    }
    thead th{ text-align:left; font-weight:700; color:var(--muted); border-bottom:1px solid var(--border);}
    tbody td{ border-bottom:1px dashed var(--border) }
    .pill {
      padding: 5px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 13px;
      background: rgba(34,211,238,.07);
      border: 1.2px solid rgba(34,211,238,.19);
      transition: background .15s;
      display:inline-flex; gap:6px; align-items:center;
    }
    .pill.income { color: var(--ok); background: rgba(16,185,129,.15); }
    .pill.expense { color: var(--danger); background: rgba(244,63,94,.13); }
    .form{ display:grid; grid-template-columns:1fr; gap:12px }
    @media (min-width: 860px){ .form{ grid-template-columns:repeat(2, 1fr) } }
    .form .field{ display:grid; gap:8px }
    .form label{ font-weight:700; font-size:13px; color:var(--muted) }
    .form input, .form select, .form textarea{
      width:100%; padding:11px 12px; border-radius:12px; background:#0b1424; border:1.5px solid var(--border); color:var(--text); outline:0; font-size:15px;
      transition: border-color .18s, box-shadow .18s;
    }
    .form textarea{ min-height:88px; grid-column:1 / -1 }
    .form input:focus, .form select:focus, .form textarea:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .footer-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px }
    .ok{ color:var(--ok) } .bad{ color:var(--bad) }
    section[hidden]{ display:none !important }
    .muted{ color:var(--muted) }
    .space{ height:8px }
    .spacer{ height:18px }
    .divider{ height:1px; background:var(--border); margin:10px 0 }
    .right{ text-align:right }
    .center{ text-align:center }
    .hero{ display:grid; gap:16px; padding:12px 0 18px }
    .hero h1{ font-size:32px; line-height:1.1; margin:0 }
    .hero p{ color:var(--muted); max-width:60ch }
    .hero .cta{ display:flex; gap:10px; flex-wrap:wrap }
    .notice{ font-size:12px; color:var(--muted) }
    .tabbed { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap:wrap; }
    .tab-btn { min-width: 120px; }
    .presc-table, .inv-table { margin-top:10px; }
    .inv-actions { display:flex; gap:6px; }
    ::-webkit-scrollbar { width: 8px; background: var(--panel-2); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    @media (max-width: 700px) {
      .app { grid-template-columns: 1fr; }
      aside { position:static; height:auto; border-right:none; }
      main { padding: 12px; }
      .cards { grid-template-columns:1fr; }
      .grid-2 { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside>
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/></svg>
        </div>
        MediLedger<br/>
      </div>
      <small class="muted">Doctor Finance — Demo</small>
      <nav aria-label="Primary">
        <button class="nav-btn active" data-route="landing">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
          Landing
        </button>
        <button class="nav-btn" data-route="add">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
          Add Transaction
        </button>
        <button class="nav-btn" data-route="dashboard">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h7v9H3zM14 3h7v5h-7zM14 12h7v9h-7zM3 15h7v6H3z"/></svg>
          Dashboard
        </button>
        <button class="nav-btn" data-route="list">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01"/></svg>
          Transactions
        </button>
        <button class="nav-btn" data-route="prescription">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H19"/><path d="M19 17V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v12"/></svg>
          Doctor Prescription
        </button>
        <button class="nav-btn" data-route="inventory">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18"/><path d="M3 9h18"/></svg>
          Inventory
        </button>
      </nav>
      <div class="spacer"></div>
      <button class="btn primary" id="seedBtn">Load Sample Data</button>
      <div class="space"></div>
      <button class="btn ghost" id="clearBtn">Clear All Data</button>
      <div class="aside-footer">
        <div class="divider"></div>
        <div>Currency: <strong id="currencyLabel">₹</strong></div>
        <div class="space"></div>
        <label class="muted" for="currencySelect">Change</label>
        <select id="currencySelect" style="width:100%; padding:8px 10px; border-radius:10px; background:#0b1424; border:1px solid var(--border); color:var(--text)">
          <option value="INR">INR (₹)</option>
          <option value="USD">USD ($)</option>
          <option value="EUR">EUR (€)</option>
          <option value="GBP">GBP (£)</option>
        </select>
        <div class="space"></div>
        <small class="notice">Your entries are stored locally in your browser (LocalStorage) in this demo.<br/>To use Firebase, connect your API keys.</small>
      </div>
    </aside>
    <main>
      <div class="toolbar">
        <div class="search"><input id="search" type="search" placeholder="Search patient, ID, notes... (⌘/Ctrl + K)"/></div>
        <button class="btn" data-route="add">+ New Transaction</button>
        <button class="btn" id="exportCsv">Export CSV</button>
      </div>
      <section id="landing">
        <div class="hero">
          <h1>Manage your clinic finances with clarity.</h1>
          <p>MediLedger helps doctors track income and expenses, visualize trends, and keep a clean audit trail — without spreadsheets. This single-file demo runs entirely in your browser.</p>
          <div class="cta">
            <button class="btn primary" data-route="add">Add your first transaction</button>
            <button class="btn" data-route="dashboard">View dashboard</button>
          </div>
        </div>
        <div class="cards">
          <div class="card">
            <div class="card-title">Why MediLedger?</div>
            <ul class="muted">
              <li>Fast add form with patient context</li>
              <li>Clean charts for monthly income vs expenses</li>
              <li>Category insights and CSV export</li>
            </ul>
          </div>
          <div class="card">
            <div class="card-title">Privacy-first (Demo)</div>
            <p class="muted">Data is saved only in your browser. Connect a backend later (Google Sheets, Firebase, Supabase) to collaborate.</p>
          </div>
          <div class="card">
            <div class="card-title">Next steps</div>
            <p class="muted">Turn this into a full app by wiring the form to your backend API and replacing LocalStorage reads/writes with fetch calls.</p>
          </div>
        </div>
      </section>
      <section id="add" hidden>
        <h2 class="card-title">Add Transaction</h2>
        <form id="txForm" class="form" autocomplete="on">
          <div class="field">
            <label for="date">Date</label>
            <input id="date" name="date" type="date" required />
          </div>
          <div class="field">
            <label for="type">Type</label>
            <select id="type" name="type" required>
              <option value="Income">Income</option>
              <option value="Expense">Expense</option>
            </select>
          </div>
          <div class="field">
            <label for="amount">Amount</label>
            <input id="amount" name="amount" type="number" step="0.01" min="0" placeholder="0.00" required />
          </div>
          <div class="field">
            <label for="category">Category</label>
            <select id="category" name="category" required>
              <option>Consultation</option>
              <option>Procedure</option>
              <option>Diagnostics</option>
              <option>Pharmacy</option>
              <option>Supplies</option>
              <option>Rent</option>
              <option>Utilities</option>
              <option>Staff</option>
              <option>Misc</option>
            </select>
          </div>
          <div class="field">
            <label for="patientName">Patient Name (optional for expenses)</label>
            <input id="patientName" name="patientName" type="text" placeholder="e.g., Rahul Kumar" />
          </div>
          <div class="field">
            <label for="patientId">Patient ID</label>
            <input id="patientId" name="patientId" type="text" placeholder="e.g., P-1024" />
          </div>
          <div class="field">
            <label for="phone">Phone</label>
            <input id="phone" name="phone" type="tel" placeholder="e.g., 98765 43210" />
          </div>
          <div class="field">
            <label for="payment">Payment Method</label>
            <select id="payment" name="payment">
              <option>Cash</option>
              <option>Card</option>
              <option>UPI</option>
              <option>Insurance</option>
              <option>Bank Transfer</option>
            </select>
          </div>
          <div class="field" style="grid-column:1 / -1">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" placeholder="Add any details..."></textarea>
          </div>
          <div class="footer-actions" style="grid-column:1 / -1">
            <button type="reset" class="btn">Reset</button>
            <button type="submit" class="btn primary">Save Transaction</button>
          </div>
        </form>
      </section>
      <section id="dashboard" hidden>
        <h2 class="card-title">Dashboard</h2>
        <div class="cards">
          <div class="card">
            <div class="kpi"><span id="kpiIncome">₹0</span> <small>Total Income</small></div>
          </div>
          <div class="card">
            <div class="kpi"><span id="kpiExpense">₹0</span> <small>Total Expenses</small></div>
          </div>
          <div class="card">
            <div class="kpi"><span id="kpiNet">₹0</span> <small>Net</small></div>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="grid-2">
          <div class="card">
            <div class="card-title">Monthly Income vs Expense</div>
            <div class="chart-wrap"><canvas id="monthlyChart" height="120"></canvas></div>
          </div>
          <div class="card">
            <div class="card-title">By Category</div>
            <div class="chart-wrap"><canvas id="categoryChart" height="120"></canvas></div>
          </div>
        </div>
      </section>
      <section id="list" hidden>
        <h2 class="card-title">Transactions</h2>
        <div class="card">
          <table id="txTable" aria-label="Transactions table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Patient</th>
                <th>Payment</th>
                <th>Notes</th>
                <th class="right">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <section id="prescription" hidden>
        <h2 class="card-title">Doctor Prescription</h2>
        <div class="tabbed" role="tablist">
          <button class="tab-btn active" id="tab-add-presc" role="tab" aria-selected="true">Add Prescription</button>
          <button class="tab-btn" id="tab-list-presc" role="tab">View Prescriptions</button>
        </div>
        <div id="presc-add-section">
          <form id="prescForm" class="form">
            <div class="field">
              <label for="prescDate">Date</label>
              <input id="prescDate" name="date" type="date" required/>
            </div>
            <div class="field">
              <label for="docName">Doctor Name</label>
              <input id="docName" name="doctor" type="text" required/>
            </div>
            <div class="field">
              <label for="prescPatient">Patient Name</label>
              <input id="prescPatient" name="patient" type="text" required/>
            </div>
            <div class="field">
              <label for="prescMed">Medicine(s)</label>
              <input id="prescMed" name="medicine" type="text" placeholder="e.g., Paracetamol, Amoxicillin" required/>
            </div>
            <div class="field" style="grid-column:1 / -1">
              <label for="prescNotes">Notes</label>
              <textarea id="prescNotes" name="notes" placeholder="Dosage, advice, etc."></textarea>
            </div>
            <div class="footer-actions" style="grid-column:1 / -1">
              <button type="reset" class="btn">Reset</button>
              <button type="submit" class="btn primary">Save Prescription</button>
            </div>
          </form>
        </div>
        <div id="presc-list-section" style="display:none">
          <table class="presc-table" aria-label="Prescriptions table">
            <thead>
              <tr>
                <th>Date</th><th>Doctor</th><th>Patient</th><th>Medicine(s)</th><th>Notes</th><th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="prescTableBody"></tbody>
          </table>
        </div>
      </section>
      <section id="inventory" hidden>
        <h2 class="card-title">Pharmacy Inventory</h2>
        <div class="tabbed" role="tablist">
          <button class="tab-btn active" id="tab-add-inv" role="tab" aria-selected="true">Add Item</button>
          <button class="tab-btn" id="tab-list-inv" role="tab">View Inventory</button>
        </div>
        <div id="inv-add-section">
          <form id="invForm" class="form">
            <div class="field">
              <label for="invName">Medicine Name</label>
              <input id="invName" name="name" type="text" required/>
            </div>
            <div class="field">
              <label for="invBatch">Batch No.</label>
              <input id="invBatch" name="batch" type="text" required/>
            </div>
            <div class="field">
              <label for="invExpiry">Expiry Date</label>
              <input id="invExpiry" name="expiry" type="date" required/>
            </div>
            <div class="field">
              <label for="invQty">Quantity</label>
              <input id="invQty" name="quantity" type="number" min="0" required/>
            </div>
            <div class="field">
              <label for="invSupplier">Supplier</label>
              <input id="invSupplier" name="supplier" type="text"/>
            </div>
            <div class="footer-actions" style="grid-column:1 / -1">
              <button type="reset" class="btn">Reset</button>
              <button type="submit" class="btn primary">Save Item</button>
            </div>
          </form>
        </div>
        <div id="inv-list-section" style="display:none">
          <table class="inv-table" aria-label="Inventory table">
            <thead>
              <tr>
                <th>Medicine</th><th>Batch</th><th>Expiry</th><th>Qty</th><th>Supplier</th><th class="right">Actions</th>
              </tr>
            </thead>
            <tbody id="invTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>
  <script>
    // ====== Utilities ======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];

    const API_BASE = "/api/transactions";
    const currencyKey = 'mediledger.currency';

    const currencyMap = {
      INR: { symbol:'₹', locale: 'en-IN' },
      USD: { symbol:'$', locale: 'en-US' },
      EUR: { symbol:'€', locale: 'de-DE' },
      GBP: { symbol:'£', locale: 'en-GB' },
    };

    let transactions = [];
    let currentCurrency = localStorage.getItem(currencyKey) || 'INR';

    function fmtMoney(n){
      const cfg = currencyMap[currentCurrency] || currencyMap.INR;
      try{ return new Intl.NumberFormat(cfg.locale, { style:'currency', currency: currentCurrency }).format(n); }
      catch{ return cfg.symbol + (n||0).toFixed(2) }
    }

    // ====== Routing ======
    function go(route){
      $$('.nav-btn').forEach(b=>b.classList.toggle('active', b.dataset.route===route));
      $$('main > section').forEach(s=>{
        s.hidden = (s.id !== route);
      });
    }

    // ====== API Communication ======
    async function load(){
      try {
        const response = await fetch(API_BASE);
        if (!response.ok) throw new Error('Failed to fetch transactions');
        const data = await response.json();
        
        // Transform backend data to match frontend format
        transactions = data.map(item => ({
          id: item.ID.toString(), // Convert ID to string
          date: item.Date,
          type: item.Type,
          amount: parseFloat(item.Amount),
          category: item.Category,
          patientName: item['Patient Name'],
          patientId: item['Patient ID'],
          phone: item.Phone,
          payment: item.Payment,
          notes: item.Notes
        }));
        
        renderAll();
      } catch (error) {
        console.error("Error loading transactions:", error);
        alert("Failed to load transactions. Check console for details.");
        transactions = [];
        renderAll();
      }
    }

    async function saveTransaction(tx) {
      try {
        const response = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            date: tx.date,
            type: tx.type,
            amount: tx.amount,
            category: tx.category,
            patientName: tx.patientName,
            patientId: tx.patientId,
            phone: tx.phone,
            payment: tx.payment,
            notes: tx.notes
          })
        });
        
        if (!response.ok) throw new Error('Failed to save transaction');
        
        // Reload data from backend to get the updated list with proper IDs
        await load();
        return true;
      } catch (error) {
        console.error("Error saving transaction:", error);
        alert("Failed to save transaction. Check console for details.");
        return false;
      }
    }

    async function deleteTransaction(id) {
      try {
        // Find the transaction to get its row ID
        const transaction = transactions.find(t => t.id === id);
        if (!transaction) throw new Error('Transaction not found');
        
        // Extract the numeric ID for the backend
        const rowId = parseInt(transaction.id);
        
        const response = await fetch(`${API_BASE}/${rowId}`, {
          method: "DELETE"
        });
        
        if (!response.ok) throw new Error('Failed to delete transaction');
        
        // Reload data from backend
        await load();
        return true;
      } catch (error) {
        console.error("Error deleting transaction:", error);
        alert("Failed to delete transaction. Check console for details.");
        return false;
      }
    }

    // ====== Form Submit ======
    $('#txForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const amount = parseFloat(data.amount || '0');
      if(!isFinite(amount) || amount <= 0){ alert('Enter a valid amount'); return; }
      
      const tx = {
        date: data.date || new Date().toISOString().slice(0,10),
        type: data.type,
        amount,
        category: data.category,
        patientName: data.patientName?.trim() || '',
        patientId: data.patientId?.trim() || '',
        phone: data.phone?.trim() || '',
        payment: data.payment,
        notes: data.notes?.trim() || ''
      };
      
      const success = await saveTransaction(tx);
      if (success) {
        e.target.reset();
        $('#date').value = new Date().toISOString().slice(0,10);
        go('list');
      }
    });

    // ====== Rendering ======
    function renderKPIs(){
      const income = transactions.filter(t=>t.type==='Income').reduce((a,b)=>a+b.amount,0);
      const expense = transactions.filter(t=>t.type==='Expense').reduce((a,b)=>a+b.amount,0);
      $('#kpiIncome').textContent = fmtMoney(income);
      $('#kpiExpense').textContent = fmtMoney(expense);
      $('#kpiNet').textContent = fmtMoney(income - expense);
    }

    function monthlyBuckets(){
      const map = new Map(); // key: YYYY-MM
      for(const t of transactions){
        const ym = (t.date||'').slice(0,7);
        if(!map.has(ym)) map.set(ym, { income:0, expense:0 });
        map.get(ym)[t.type.toLowerCase()] += t.amount;
      }
      const keys = [...map.keys()].sort();
      const income = keys.map(k=>map.get(k).income);
      const expense = keys.map(k=>map.get(k).expense);
      return { labels: keys, income, expense };
    }

    function categoryTotals(){
      const map = new Map();
      for(const t of transactions){
        const k = t.category||'Misc';
        if(!map.has(k)) map.set(k, { income:0, expense:0 });
        map.get(k)[t.type.toLowerCase()] += t.amount;
      }
      const labels = [...map.keys()].sort();
      const totals = labels.map(l=> map.get(l).income - map.get(l).expense );
      return { labels, totals };
    }

    let monthlyChart, categoryChart;
    function renderCharts(){
      const m = monthlyBuckets();
      const c = categoryTotals();

      const ctxM = $('#monthlyChart');
      const ctxC = $('#categoryChart');

      if(monthlyChart) monthlyChart.destroy();
      if(categoryChart) categoryChart.destroy();

      monthlyChart = new Chart(ctxM, {
        type:'bar',
        data:{ labels: m.labels, datasets:[
          { label:'Income', data:m.income, borderWidth:2, backgroundColor: 'rgba(75, 192, 192, 0.6)' },
          { label:'Expense', data:m.expense, borderWidth:2, backgroundColor: 'rgba(255, 99, 132, 0.6)' }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });

      categoryChart = new Chart(ctxC, {
        type:'bar',
        data:{ labels:c.labels, datasets:[ { 
          label:'Net by Category', 
          data:c.totals, 
          borderWidth:2,
          backgroundColor: 'rgba(54, 162, 235, 0.6)'
        } ] },
        options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{ x:{ beginAtZero:true } } }
      });
    }

    function renderTable(){
      const tbody = $('#txTable tbody');
      const q = $('#search').value.trim().toLowerCase();
      tbody.innerHTML = '';
      const cfg = currencyMap[currentCurrency];

      const rows = transactions.filter(t=>{
        if(!q) return true;
        return [t.patientName, t.patientId, t.phone, t.category, t.payment, t.notes].some(v=> String(v||'').toLowerCase().includes(q));
      }).map(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.date}</td>
          <td><span class="pill ${t.type.toLowerCase()}">${t.type}</span></td>
          <td>${fmtMoney(t.amount)}</td>
          <td>${t.category}</td>
          <td>${t.patientName || '-'}${t.patientId?` <span class="muted">(${t.patientId})</span>`:''}</td>
          <td>${t.payment}</td>
          <td>${t.notes || ''}</td>
          <td class="right"><button class="btn ghost" data-del="${t.id}">Delete</button></td>
        `;
        return tr;
      });

      rows.forEach(r=>tbody.appendChild(r));

      // delete handlers
      $$('button[data-del]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute('data-del');
          if(confirm('Are you sure you want to delete this transaction?')) {
            await deleteTransaction(id);
          }
        }
      })
    }

    function renderAll(){
      renderKPIs();
      renderCharts();
      renderTable();
      $('#currencyLabel').textContent = currencyMap[currentCurrency].symbol;
    }

    // ====== CSV Export ======
    function toCSV(){
      const header = ['Date','Type','Amount','Category','Patient Name','Patient ID','Phone','Payment','Notes'];
      const lines = transactions.map(t=>[
        t.date, t.type, t.amount, t.category, t.patientName, t.patientId, t.phone, t.payment, (t.notes||'').replaceAll('\n',' ')
      ]);
      const csv = [header, ...lines].map(r=> r.map(v=>`"${String(v??'').replaceAll('"','\"')}"`).join(',')).join('\n');
      return csv;
    }

    $('#exportCsv').onclick = ()=>{
      const blob = new Blob([toCSV()], { type:'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `mediLedger-transactions-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Remove seed and clear functionality as they don't apply to backend
    $('#seedBtn').style.display = 'none';
    $('#clearBtn').style.display = 'none';

    // Currency change
    const currencySelect = $('#currencySelect');
    currencySelect.value = currentCurrency;
    currencySelect.onchange = ()=>{
      currentCurrency = currencySelect.value;
      localStorage.setItem(currencyKey, currentCurrency);
      renderAll();
    }

    // Search
    $('#search').addEventListener('input', renderTable);
    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#search').focus(); }
    });

    // Nav buttons
    $$('button[data-route]').forEach(btn=> btn.addEventListener('click', ()=> go(btn.dataset.route)));

    // Update the notice text
    $('.notice').textContent = 'Your entries are stored in Google Sheets via the backend API.';

    // Init
    load();
    $('#date').value = new Date().toISOString().slice(0,10);
</script>
</body>
</html>
